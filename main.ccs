#!/usr/bin/env bash
set -e

echo "üöÄ Starting Swiftbot AI + Yed Workspace..."

################################
# 1Ô∏è‚É£ Load AI keys
################################
if [[ -z "$GOOGLE_API_KEY" || -z "$OPENAI_API_KEY" ]]; then
    echo "‚ö†Ô∏è AI keys not found! Set GOOGLE_API_KEY and OPENAI_API_KEY in Codespaces secrets."
else
    export GOOGLE_API_KEY=$GOOGLE_API_KEY
    export OPENAI_API_KEY=$OPENAI_API_KEY
    echo "üîê AI keys loaded."
fi

################################
# 2Ô∏è‚É£ Node dependencies
################################
if [ -f package.json ]; then
    echo "üì¶ Installing Node packages..."
    npm install
fi

################################
# 3Ô∏è‚É£ Python environment
################################
echo "üêç Setting up Python virtual environment..."
python3 -m venv venv || true
source venv/bin/activate
pip install --upgrade pip
if [ -f requirements.txt ]; then
    pip install -r requirements.txt
fi

################################
# 4Ô∏è‚É£ Swift backend
################################
if command -v swift >/dev/null 2>&1; then
    echo "üß† Building Swiftbot backend..."
    swift build || true
fi

################################
# 5Ô∏è‚É£ Docker stack
################################
if [ -f docker-compose.yml ]; then
    echo "üê≥ Building and starting Docker stack..."
    docker compose build || true
    docker compose up -d
fi

################################
# 6Ô∏è‚É£ Frontend scaffold
################################
if [ ! -d liveblocks-ui ]; then
    echo "‚öõÔ∏è Creating Liveblocks UI..."
    mkdir liveblocks-ui
    cd liveblocks-ui
    npx create-liveblocks-app@latest --init --framework react
    cd ..
fi

################################
# 7Ô∏è‚É£ Start backend & frontend
################################
echo "üèÅ Launching Swiftbot backend..."
if command -v swift >/dev/null 2>&1; then
    swift run swiftbot chat &
fi

echo "üèÅ Launching frontend..."
if [ -f package.json ]; then
    npm run dev &
fi

################################
# 8Ô∏è‚É£ Launch Yed (graph editor)
################################
if command -v yed >/dev/null 2>&1; then
    echo "üñ§ Launching Yed..."
    yed &
else
    echo "‚ö†Ô∏è Yed not found. Please install Yed manually or add it to PATH."
fi

################################
# 9Ô∏è‚É£ Done
################################
echo "‚úÖ Swiftbot AI + Yed Workspace fully running!"
echo "Frontend port 3000, Backend port 8000 (Codespaces forwarded)."
echo "Use CTRL+C to stop all background processes if needed."
wait
